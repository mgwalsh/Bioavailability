---
title: Spectral predictions of Zinc concentrations in Maize grain and soils
author: M.G. Walsh, P.C. Nalivata, E. Towett, R.M. Lark, ...
date: "`r format(Sys.time(), '%d, %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 1
    fig_caption: true
    css: style.css
---

```{r, echo=FALSE}
knitr::opts_chunk$set(message = FALSE)
```

# Introduction

Zinc (Zn) is a trace element found in varying concentrations in all soils, plants and animals. It is essential for the normal growth of higher plants, animals and humans. While Zn is needed in only small quantities, if those amounts are inadequate, plants and/or animals will suffer from physiological stress brought about by the dysfunction of several enzyme systems and other metabolic functions in which Zn plays a key role. In Malawi, Zn deficiency prevalence rates of 59-62% in people have been reported based on a national survey of serum Zn concentrations ([Likoswe et al., 2020](https://doi.org/10.3390/nu12061563)). This value may be even higher in the rural areas ([Siyame et al., 2013](https://doi.org/10.1024/0300-9831/a000158)).

The spectral signatures of soils, plants and materials generally are defined by their reflectance or absorbance as a function of wavelength in the electromagnetic spectrum. Under controlled conditions, the signatures result from electronic transitions of atoms and vibrational stretching and bending of structural groups of atoms that form molecules or crystals. Spectroscopy has been shown to provide highly repeatable, rapid and low cost measurements of many different soil and plant properties in numerous studies. The amount of light absorbed by a sample can be measured with minimal sample preparation (primarily drying and fine grinding) across a wide range of ultra-violet (UV), visible (VIS), near (NIR) and mid-infrared (MIR) wavelengths to provide a unique spectral signature. An individual measurement can be performed in about 30 seconds, in contrast to conventional soil and plant tests, which are typically slow, labor-intensive, expensive and/or use harmful chemicals.

This notebook is intended for self-learning. It does not go into the details of the [spectroscopy](https://en.wikipedia.org/wiki/Spectroscopy) itself, but instead it focuses on **spectrometry** processes and the associated computing workflows that are needed to generate useful predictions from a population of spectral signatures of  (features) relative to their corresponding reference measurements (labels). In this particular example, we shall use topsoil (0-20 cm) and co-located maize grain Zn concentration data that were collected as part of the [GeoNutrition project](http://www.geonutrition.com) in Malawi.

# General data setup

To actually run this notebook, you will need to load the packages indicated in the chunk directly below. This allows you to assemble the wet chemistry and spectral dataframes providing a lot of options to generate spectral predictions of Zn plant and soil micro-nutrient. The notebook itself is maintained on [Github](https://github.com/mgwalsh/Bioavailability/blob/master/Zn_preds.Rmd), and you can fork and modify it from there as you see fit.

```{r}
# Package names
packages <- c("downloader", "caret", "caretEnsemble", "soil.spec", "MASS", "pls", "glmnet", "randomForest", "xgboost", "Cubist", "quantreg", "leaflet", "htmlwidgets", "plyr", "dplyr", "doParallel")

# Install packages
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Load packages
invisible(lapply(packages, library, character.only = TRUE))
```

The next chunk downloads the data needed for running this example. It assembles georeferenced soil measurements collected across Africa and links these to [Bruker Alpha FT-IR](https://www.bruker.com/en/products-and-solutions/infrared-and-raman/ft-ir-routine-spectrometer/alpha-ii-compact-ft-ir-spectrometer.html) spectra. Note that this chunk is Mac or Linux specific and so the directory structures would need to be changed slightly to run on Windows machines.

```{r}
# Create a data folder in your current working directory
dir.create("Zn_preds", showWarnings = F)
setwd("./Zn_preds")
dir.create("Results", showWarnings = F)

# Data download
download("https://osf.io/f4dpw/?raw=1", "acidity_data.zip", mode="wb")
unzip("acidity_data.zip", overwrite = T)
prof <- read.table("profiles.csv", header=T, sep=",") ## sample locations and depths
cnls <- read.table("cnls.csv", header=T, sep=",") ## wet chemistry data from CNLS, Nairobi
cnls$xCEC <- cnls$m3Ca/200+cnls$m3Mg/120+cnls$m3K/390+cnls$Hp ## calculates extractable (xCEC)  
text <- read.table("text.csv", header=T, sep=",") ## AfSIS LDPSA soil texture
oxid <- read.table("oxid.csv", header=T, sep=",") ## AfSIS XRF metal oxide data
spec <- read.table("alpha_spec.csv", header=T, sep=",") ## AfSIS spectral absorbance data
  
# Merge the wet chemistry reference dataframes
adata <- merge(prof, cnls, by = "ssid")
adata <- merge(adata, text, by = "ssid")
adata <- merge(adata, oxid, by = "ssid")

# Download figures
download("https://osf.io/42gry/", "figures.zip", mode = "wb")
exdir <- "./Figures" 
unzip("figures.zip", exdir = exdir, overwrite = T)
```

The following chunk then writes out the dataframe `AfSIS_reference_data.csv` into your `./soil_acidity/Results` directory if you'd like to process those outputs in software other than R. It also generates a location map of where those soil samples were obtained.

```{r}
# Write out reference data frame
write.csv(adata, "./soil_acidity/Results/AfSIS_reference_data.csv", row.names = F)

# Soil sample locations
w <- leaflet() %>%
  setView(lng = mean(adata$lon), lat = mean(adata$lat), zoom = 3) %>%
  addProviderTiles(providers$OpenStreetMap.Mapnik) %>%
  addCircleMarkers(adata$lon, adata$lat, clusterOptions = markerClusterOptions())
w ## plot widget 
```

