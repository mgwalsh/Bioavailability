---
title: Spectral workflows for predicting Zinc concentrations in Maize grain and soils
author: M.G. Walsh, P.C. Nalivata, E. Towett, M. Broadley ...
date: "Last compiled on `r format(Sys.time(), '%d, %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 1
    fig_caption: true
    css: style.css
---

```{r, echo=FALSE}
knitr::opts_chunk$set(message = FALSE)
```

# Introduction

Micronutrients i.e., essential vitamins and minerals, are vital to healthy development and disease prevention. With the exception of vitamin D, micronutrients are not produced in the body and must be derived from the diet. Though people only need small amounts of micronutrients, consuming their recommended amounts is important, as *micronutrient deficiencies* (MNDs) can have severe consequences. Zinc deficiency is among the 5 most widespread MNDs (including Iron, Vitamin A, Iodine, Folate and Zinc) of greatest global concern [Bailey et al (2015)](https://doi.org/10.1159/000371618) and is the focus of this notebook. 

Zinc (Zn) is a trace element found in varying concentrations in all soils, plants and animals. It is essential for the normal growth of higher plants, animals and humans. While Zn is needed in only small quantities, if those amounts are inadequate, plants and/or animals will suffer from physiological stress brought about by the dysfunction of several enzyme systems and other metabolic functions in which Zn plays a key role [Wessels and Brown (2012)](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0050568). In Malawi, Zn deficiency prevalence rates of 59-62% in people have been reported based on a national survey of serum Zn concentrations ([Likoswe et al., 2020](https://doi.org/10.3390/nu12061563)). This value may be even higher in the rural areas ([Siyame et al., 2013](https://doi.org/10.1024/0300-9831/a000158)).

The spectral signatures of soils, plants and materials generally are defined by their reflectance or absorbance as a function of wavelength in the electromagnetic spectrum. Under controlled conditions, the signatures result from electronic transitions of atoms and vibrational stretching and bending of structural groups of atoms that form molecules or crystals. Spectroscopy has been shown to provide highly repeatable, rapid and low cost measurements of many different soil and plant properties in numerous studies. The amount of light absorbed by a sample can be measured with minimal sample preparation (primarily drying and fine grinding) across a wide range of ultra-violet (UV), visible (VIS), near (NIR) and mid-infrared (MIR) wavelengths to provide a unique spectral signature. An individual measurement can be performed in about 30 seconds, in contrast to conventional soil and plant tests, which are typically slow, labor-intensive, expensive and/or use hazardous chemicals. The main questions posed here are:

* Can we use MIR spectra to predict Zn concentrations in Maize grain and soils reliably?

* Are those predictions *useful enough* to guide Zn deficiency diagnostics?

The notebook is intended for self-learning. It does not go into the details of the [spectroscopy](https://en.wikipedia.org/wiki/Spectroscopy) itself (and which is well covered in the literature), but instead it focuses on *spectrometry* processes and the associated computing workflows that are needed to generate useful predictions from a population of spectral signatures of  (features) relative to their corresponding reference measurements (labels). In this particular example, we shall use topsoil (0-20 cm) and co-located maize grain Zn concentration data that were collected as part of the [GeoNutrition project](http://www.geonutrition.com) in Malawi.

# General data setup

To actually run this notebook, you will need to load the packages indicated in the chunk directly below. This allows you to assemble the wet chemistry and spectral dataframes providing a lot of options to generate spectral predictions of Zn plant and soil micro-nutrient. The notebook itself is maintained on [Github](https://github.com/mgwalsh/Bioavailability/blob/master/Zn_preds.Rmd), and you can fork and modify it from there as you see fit.

```{r}
# Package names
packages <- c("downloader", "caret", "caretEnsemble", "soil.spec", "MASS", "pls", "glmnet", "randomForest", "xgboost", "Cubist", "quantreg", "leaflet", "htmlwidgets", "plyr", "dplyr", "doParallel")

# Install packages
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Load packages
invisible(lapply(packages, library, character.only = TRUE))
```

The next chunk downloads the data needed for running this example. It assembles georeferenced soil measurements collected across Africa and links these to [FT-IR](https://www.bruker.com/en/products-and-solutions/infrared-and-raman/ft-ir-routine-spectrometer/alpha-ii-compact-ft-ir-spectrometer.html) spectra. Note that this chunk is Mac or Linux specific and so the directory structures would need to be changed slightly to run on Windows machines.

```{r}
# Create a data folder in your current working directory
dir.create("MW_Zn", showWarnings = F)
setwd("./MW_Zn")
dir.create("Results", showWarnings = F)
```

The following chunk then writes out the dataframe `MW_Zn_data.csv` into your `./MW_Zn/Results` directory if you'd like to process those outputs in software other than R. It also generates a location map of where those soil samples were obtained.

