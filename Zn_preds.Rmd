---
title: Spectrometry workflows for predicting zinc levels in soils and maize grain
author: M.G. Walsh, P.C. Nalivata, E.K. Towett, R.M. Lark and M.R. Broadley
date: "Last compiled on `r format(Sys.time(), '%d, %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 1
    fig_caption: true
    css: style.css
---

```{r, echo=FALSE}
knitr::opts_chunk$set(message = FALSE)
```

# Introduction

Micronutrients i.e., the essential vitamins and minerals, are vital for healthy child development as well as morbidity and disease prevention in adults. With the exception of vitamin D, micronutrients are not produced in the body and must be obtained from the diet. Although people only need small amounts of micronutrients, consuming the recommended amount is important, as *micronutrient deficiencies* (MNDs) can have severe consequences to both health and well-being. However, national surveys containing dietary micronutrient intake data are not routinely collected in most developing countries because they are expensive and time consuming to obtain both in the field and the laboratory. Also, the databases that are needed to analyze dietary intakes should be geographically explicit to be effective, but they are often completely lacking and/or not up-to-date in Africa. Similarly, agronomic interventions that focus on plant micronutrients for improving cropland productivity are inadequately supported by spatial and temporal data. Surveillance of MNDs on the basis of biomarkers of status and dietary intakes from national and regional-scale staple food-composition data would be improved using subnational data on the composition of grain micronutrients [Gashu et al (2021)](https://doi.org/10.1038/s41586-021-03559-3).

Zinc (Zn) deficiency is among the 5 most widespread MNDs (including iron, vitamin A, iodine, folate, in addition to zinc) that are of global concern [Bailey et al (2015)](https://doi.org/10.1159/000371618). Diagnosing zinc deficiency in soils and maize grain is the focus of this notebook. Zn is a trace element found in varying concentrations in all soils, plants and animals. It is essential for the normal growth of higher plants, animals and humans [Noulas et al (2018)](). While Zn is needed in only small quantities, if those amounts are inadequate, plants and/or animals will suffer from physiological stress brought about by the dysfunction of several enzyme systems and other metabolic functions in which Zn plays a key role see [Wessels and Brown (2012)](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0050568). In Malawi, Zn deficiency prevalence rates of ~60% in people have been reported based on a national survey of serum [biomarker](https://en.wikipedia.org/wiki/Biomarker) Zn concentrations ([Likoswe et al., 2020](https://doi.org/10.3390/nu12061563)). The prevalence may be even higher in rural areas ([Siyame et al., 2013](https://doi.org/10.1024/0300-9831/a000158)). The main causes of Zn deÔ¨Åciencies in food crops are soil-related including: total Zn and clay content, redox potential, activity of soil microorganisms, the presence of other nutrients, and climate conditions, see e.g., [Noulas et al (2018)](https://doi.org/10.1016/j.jtemb.2018.02.009).

Spectral signatures of soils, plants, animal tissues and materials generally are defined by their reflectance or absorbance as a function of wavelength in the electromagnetic spectrum. Under laboratory conditions, the signatures result from electronic transitions of atoms and vibrational stretching and bending of structural groups of atoms that form molecules or crystals. Spectroscopy has been shown to provide highly repeatable, rapid and low cost measurements of many different soil, plant and animal tissue properties in numerous studies. The amount of light absorbed by a sample can be measured with minimal sample preparation (primarily drying and fine grinding) across a wide range of ultra-violet (UV), visible (VIS), near (NIR) and mid-infrared (MIR) wavelengths to provide a unique spectral signature. An individual measurement can be performed in about 30 seconds, in contrast to more conventional soil and plant tests, which are typically slow, labor-intensive, expensive and/or use hazardous chemicals, which have to be handled carefully. 

In this notebook we shall explore if Zn concentrations in soils and maize grain can be reliably predicted from cheap fast, non-destructive and non-hazardous MIR spectral data (features), using [ICP-MS](https://en.wikipedia.org/wiki/Inductively_coupled_plasma_mass_spectrometry) as reference (label) data with standard *machine learning algorithms* ([MLAs](https://en.wikipedia.org/wiki/Machine_learning)).

The two main empirical questions posed here given a specific dataset are:

* Can Zn concentrations in soils be used to predict Zn concentrations in maize grain? While there should be strong bio-kinetic links between soils and plants, the differential uptake and bioavailability of soil Zn in food crop tissues are generally complex and are not well quantified or predicted. 

* Can we use MIR spectra to predict Zn concentrations in maize grain and soils reliably? If so, this would advance and enable localized Zn deficiency diagnostics and risk assessments that could potentially be carried out routinely and operationally, at low cost, and across large geographical regions and populations of interest. 

The notebook is also intended for self-learning in [R](https://www.r-project.org/). It does not go into the details of the underlying [spectroscopy](https://en.wikipedia.org/wiki/Spectroscopy) that is widely covered in the literature, but instead it focuses on [spectrometry](https://en.wikipedia.org/wiki/Spectrophotometry) the associated computing workflows that are needed to generate useful predictions from a population of spectral signatures of (features) relative to their corresponding reference measurements (labels). In this particular example, we shall use topsoil (0-20 cm) Zn concentration data, co-located maize grain data and MIR spectral data that were collected as part of the [GeoNutrition project](http://www.geonutrition.com) in Malawi. The described workflows might also be transferable to diagnosing other MNDs in soils and crops and/or to other geographies via e.g., [transfer learning](https://en.wikipedia.org/wiki/Transfer_learning) and/or other approaches ... tbd.

# General data setup

To actually run this notebook, you will need to load the packages indicated in the chunk directly below. This allows you to assemble the wet chemistry and spectral dataframes providing a lot of options to generate spectral predictions of Zn concentrations in soils and Maize grain. The notebook itself is maintained on [Github](https://github.com/mgwalsh/Bioavailability/blob/master/Zn_preds.Rmd), and you can fork and modify it from there as you see fit.

```{r}
# Package names
packages <- c("downloader", "caret", "caretEnsemble", "soil.spec", "MASS", "pls", "glmnet", "randomForest", "xgboost", "Cubist", "quantreg", "leaflet", "htmlwidgets", "plyr", "dplyr", "doParallel")

# Install packages
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Load packages
invisible(lapply(packages, library, character.only = TRUE))
```

The next chunk downloads the data needed for running this example. It assembles the various soil and crop measurements collected across Malawi and links these to [FT-IR](https://www.bruker.com/en/products-and-solutions/infrared-and-raman/ft-ir-routine-spectrometer/alpha-ii-compact-ft-ir-spectrometer.html) spectra. Note that this chunk is Mac or Linux specific and so the directory structures would need to be changed slightly to run on Windows machines.

```{r}
# Create a data folder in your current working directory
dir.create("MW_Zn_data", showWarnings=F)
setwd("./MW_Zn_data")
dir.create("./Results")

# Data download
download("https://osf.io/pdgk6/?raw=1", "MW_Zn_data.zip", mode="wb")
unzip("MW_Zn_data.zip", overwrite = T)
wchem <- read.table("MW_Zn_data.csv", header=T, sep=",") 
sspec <- read.table("soil_MIR_spectra.csv", header=T, sep=",")
cspec <- read.table("plant_MIR_spectra.csv", header=T, sep=",")

# Merge the wet chemistry reference data frame with the corresponding spectra
sdata <- merge(wchem, sspec, by = "ssid") ## soil data frame
cdata <- merge(wchem, cspec, by = "csid") ## crop data frame
```

The following chunk then writes out the data frames `MW_soil_Zn_data.csv` and `MW_crop_Zn_data.csv` into your `./MW_Zn_data/Results` directory if you'd like to process those outputs in software other than R. It also generates a location map of where those soil and plant samples were obtained.

```{r}
# Write out reference data frame
write.csv(sdata, "./MW_Zn_data/Results/MW_soil_Zn_data.csv", row.names = F)
write.csv(sdata, "./MW_Zn_data/Results/MW_crop_Zn_data.csv", row.names = F)

# Soil sample locations
w <- leaflet() %>%
  setView(lng = mean(wchem$lon), lat = mean(wchem$lat), zoom = 7) %>%
  addProviderTiles(providers$OpenStreetMap.Mapnik) %>%
  addCircleMarkers(wchem$lon, wchem$lat, clusterOptions = markerClusterOptions())
w ## plot widget 
```
