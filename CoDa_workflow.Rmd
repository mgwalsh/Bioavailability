---
title: CoDA workflows for evaluating nutrient compositions of food grains
author: M.G. Walsh, R. Rodr√≠guez Iglesias, P.C. Nalivata and M.R. Broadley
date: "Last compiled on `r format(Sys.time(), '%d, %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 1
    fig_caption: true
    css: style.css
---

```{r, echo=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

# Introduction

Most models of nutrient uptake, photosynthesis, yield and/or trophic dynamics assume no interaction between individual mineral nutrients and typically describe the associated processes as a function of only the most limiting ones (i.e., the [Blackman limitation](https://www.biologydiscussion.com/photosynthesis/blackmans-law-of-limiting-factors-and-his-criticism-photosynthesis/23006)). However, the Blackman limitation does not appear to hold generally. In agricultural systems, the overall mineral nutrient composition is also likely to affect both crop yields as well as the overall nutritional quality of plant products that are subsequently consumed by animals, including humans. The main problem is that we do not know, with exception of case-studies such as this one, to what extent that statement is true. This notebook is intended to provide some analytical guidance about how to find out more about the complex interactions that are involved and to apply that information to the management of agricultural landscapes.

Compositional Data Analysis ([CoDA](http://www.compositionaldata.com/)) refers to the analyses of compositional data (CoDa), which are defined as vectors with strictly positive components whose sum is constant (e.g., 1 or 100%). The terms also cover all other vectors representing the *parts* of a whole (so-called *sub-compositions*), which carry only relative information, including parts per concentration unit (e.g., ppm or mcg), but potentially also their molar equivalents. The original approach to CoDA developed by [J. Aitchison (1982)](https://rss.onlinelibrary.wiley.com/doi/10.1111/j.2517-6161.1982.tb01195.x) uses logarithmic ratios of the compositional parts as the fundamental starting point for CoDa description and modeling. There is also a working paper by [M. Greenacre (2017)](https://econ-papers.upf.edu/papers/1554.pdf) openly available, which provides excellent guidance as well as [R code](https://github.com/michaelgreenacre/CODAinPractice) about the practical applications and interpretation of CoDa. We shall be following and testing Greenacre's pragmatic advice and approach here on a relatively large national dataset. This notebook is maintained on [Github](https://github.com/mgwalsh/Bioavailability/blob/master/CoDa_workflow.Rmd), and you can fork and alter it from there as you see fit.

The data we will be using was generated by the [GeoNutrition project](http://www.geonutrition.com) in Malawi. The data consist of 1,808 cereal grain samples that were collected for maize (1,606), pearl millet (31), rice (54), and sorghum (117) in 2019. The nationally representative cropland sampling frame and the laboratory analytically methods that were used in the data collections are described in ([Gashu et al., (2021)](https://doi.org/10.1038/s41586-021-03559-3)). The data include [ICP-MS](https://en.wikipedia.org/wiki/Inductively_coupled_plasma_mass_spectrometry) concentration measurements  of cereal mineral nutrient contents (in ppm), including: Na, Mg, P, S, K, Ca, Cr, Mn, Fe, Co, Cu, Zn, Se, Mo, and I. They also include the georeference of where the samples were collected (lon/lat, EPSG:3857), the dominant cereal crop at that location and if fertilizer and/or lime were used in growing the crop at that location.

# General data setup

To actually run this notebook, you will need to load the packages indicated in the chunk directly below to download and assemble the data. The chunk (not shown but in the markdown) also generates an overview map of where the samples were collected in Malawi ... you can click and zoom into the individual sampling locations.

```{r, results = 'hide'}
# Package names
packages <- c("osfr", "dplyr", "leaflet", "compositions", "vegan", "easyCODA")

# Install packages
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Load packages
invisible(lapply(packages, library, character.only = TRUE))

# Create a data folder in your current working directory
dir.create("MW_coda", showWarnings=F)
setwd("./MW_coda")
dir.create("Results")

# Data download from OSF at: https://osf.io/btxyc/
osf_retrieve_file("btxyc") %>% osf_download()
codat <- read.table("MW_grain_coda.csv", header=T, sep=",")
```

```{r, echo = FALSE}
# Grain sample locations
w <- leaflet() %>%
  setView(lng = mean(codat$lon), lat = mean(codat$lat), zoom = 7) %>%
  addProviderTiles(providers$OpenStreetMap.Mapnik) %>%
  addCircleMarkers(codat$lon, codat$lat, clusterOptions = markerClusterOptions())
w ## plot widget 
```

# CoDa conversions

This section of the notebook sets up 3 data frames for the subsequent CoDA. The first focuses on mineral **macro-nutrients** (i.e., Na, Mg, P, S, K, and Ca ... in atomic number order), the second on **trace nutrients** (i.e., Cr, Mn, Fe, Co, Cu, Zn, Se, Mo, and I), and the third on the combination of both the **macro and trace nutrients**. Note that the difference between macro and trace here is only intended to reflect the overall recommended daily dietary amounts that should be consumed by people, and not their nutritional importance or benefits. The differences might also be useful for spatial mapping and/or soil property and MIR spectral predictions of nutrient constraints at a later stage, and in separate notebooks.

This next chunk [closes, rather than normalizes](https://econ-papers.upf.edu/papers/1554.pdf) the relevant (`macro`, `trace` and `combined`) sub-compositional parts of the grain CoDa and calculates the *additive log-ratios* ([ALRs](https://rdrr.io/cran/compositions/man/alr.html)), which can then be analyzed, summarized and readily interpreted with both conventional univariate and multivariate methods ([Greenacre, 2017](https://econ-papers.upf.edu/papers/1554.pdf)). We also write out the wrangled data files to your `./MW_coda/Results` directory should you wish to process them in software other than R.

```{r}

```


